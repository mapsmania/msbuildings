<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Microsoft Building Footprints</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>

    <style>
        body { margin:0; overflow:hidden; }
        #map { width:100vw; height:100vh; }
        #info {
            position:absolute;
            top:10px;
            left:10px;
            background:white;
            padding:8px 12px;
            border-radius:6px;
            font-family:sans-serif;
            font-size:14px;
            box-shadow:0 2px 6px rgba(0,0,0,0.25);
            z-index:10;
        }
    </style>
</head>

<body>
<div id="info">Microsoft Buildings Demo<br>Service Worker: loading…</div>
<div id="map"></div>

<script>
// ---------------------------------------------------------
// 1. Register the service worker
// ---------------------------------------------------------
navigator.serviceWorker.register("./sw.js", { scope: "./" })
    .then(reg => {
        document.getElementById("info").innerHTML =
            "Microsoft Buildings Demo<br>Service Worker: OK ✔";
        console.log("[SW] registered:", reg);
    })
    .catch(err => {
        document.getElementById("info").innerHTML =
            "Microsoft Buildings Demo<br>Service Worker: FAILED ✖";
        console.error(err);
    });

// ---------------------------------------------------------
// 2. Custom protocol handler for msb://Z/X/Y
// ---------------------------------------------------------
maplibregl.addProtocol("msb", (params, callback) => {
    const [z, x, y] = params.url.split("/");
    const actualURL = `/msbuildings/quad/${z}/${x}/${y}.geojson`;

    fetch(actualURL)
        .then(r => r.json())
        .then(json => callback(null, json))
        .catch(err => callback(err));

    return { cancel: () => {} };
});

// ---------------------------------------------------------
// 3. Create the MapLibre map
// ---------------------------------------------------------
const map = new maplibregl.Map({
    container: "map",
    center: [23.72, 37.98], // Athens
    zoom: 14,
    style: {
        version: 8,
        sources: {
            buildings: {
                type: "geojson",
                data: "msb://14/9271/6320" // initial tile
            }
        },
        layers: [
            {
                id: "buildings-fill",
                type: "fill",
                source: "buildings",
                paint: {
                    "fill-color": "#ff5500",
                    "fill-opacity": 0.5
                }
            },
            {
                id: "buildings-outline",
                type: "line",
                source: "buildings",
                paint: {
                    "line-color": "#333",
                    "line-width": 1
                }
            }
        ]
    }
});

// ---------------------------------------------------------
// 4. Tile functions
// ---------------------------------------------------------
function lngLatToTile(lon, lat, z) {
    const x = Math.floor((lon + 180) / 360 * (1 << z));
    const y = Math.floor(
        (1 - Math.log(Math.tan(lat * Math.PI/180) +
        1 / Math.cos(lat * Math.PI/180)) / Math.PI) / 2 * (1 << z)
    );
    return { x, y };
}

function updateTiles() {
    const center = map.getCenter();
    const zoom = Math.floor(map.getZoom());
    if (zoom < 13 || zoom > 17) return;

    const centerTile = lngLatToTile(center.lng, center.lat, zoom);
    const tiles = [];

    // 3x3 tile grid around center
    for (let dx = -1; dx <= 1; dx++) {
        for (let dy = -1; dy <= 1; dy++) {
            tiles.push({
                x: centerTile.x + dx,
                y: centerTile.y + dy
            });
        }
    }

    // Fetch all tiles sequentially for simplicity
    tiles.forEach(t => {
        const url = `msb://${zoom}/${t.x}/${t.y}`;
        map.getSource("buildings").setData(url);
    });
}

// Initial tile load
map.on("load", updateTiles);

// Update on moveend
map.on("moveend", updateTiles);
</script>
</body>
</html>
